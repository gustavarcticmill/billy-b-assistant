<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Billy Bassistant</title>
    <link href="../static/css/styles.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="icon" href="../static/favicon.ico" type="image/x-icon">
</head>
<body class="text-white font-sans">

<!-- 🐟 Billy Header with Controls & Log Buttons -->
<header class="px-6 py-4 z-20 sticky top-0 backdrop-blur-sm shadow-[0_4px_10px_rgba(0,0,0,0.25)]">
    <div class="flex flex-row flex-wrap md:items-center justify-between gap-2">
        <h1 class="text-2xl font-bold flex-shrink-0">Billy Bassistant
            <span id="service-status" class="text-lg font-bold">(Loading...)</span>
        </h1>
        <div id="service-controls" class="flex gap-2 grow md:mx-10 justify-end md:justify-start">
            <!-- Service buttons inserted via JS -->
        </div>
        <div class="flex items-center gap-2 grow justify-end">
            <div id="version-info" class="text-sm text-zinc-300 flex flex-col md:items-end">
                <span id="current-version">Current: ...</span>
                <span id="latest-version" class="hidden text-amber-500">Latest: ...</span>
            </div>
            <div class="flex gap-2 items-center">
                <button id="update-btn"
                        class="hidden bg-amber-500 hover:bg-amber-400 text-zinc-800 text-sm py-1 px-3 rounded gap-1.5 items-center cursor-pointer">
                    <span class="material-icons align-middle">system_update_alt</span>
                    Update Available
                </button>
            </div>

            <button id="toggle-log-btn"
                    class="bg-zinc-700 hover:bg-zinc-600 text-white text-sm py-1 px-2 rounded flex gap-1.5 items-center cursor-pointer"
                    title="Show debug log">
                <span class="material-icons bug_report">bug_report</span>
            </button>

            <button id="toggle-env-btn"
                    class="bg-zinc-700 hover:bg-zinc-600 text-white text-sm py-1 px-2 rounded flex gap-1.5 items-center cursor-pointer"
                    title="Show .env file editor">
                <span class="material-icons">admin_panel_settings</span>
            </button>

            <button id="toggle-motion-btn"
                    class="bg-zinc-700 hover:bg-zinc-600 text-white text-sm py-1 px-2 rounded flex gap-1.5 items-center cursor-pointer"
                    title="Toggle UI animations">
                <span class="material-icons">blur_on</span>
            </button>

            <button id="reboot-billy-btn"
                    class="bg-zinc-700 hover:bg-zinc-600 text-white text-sm py-1 px-2 rounded flex gap-1.5 items-center cursor-pointer"
                    title="Reboot Billy">
                <span class="material-icons">restart_alt</span>
            </button>

            <button id="shutdown-billy-btn"
                    class="bg-zinc-700 hover:bg-zinc-600 text-white text-sm py-1 px-2 rounded flex gap-1.5 items-center cursor-pointer"
                    title="Shutdown Billy">
                <span class="material-icons">power_off</span>
            </button>
        </div>
    </div>

    <!-- Log Panel -->
    <section id="log-panel" class="mt-2 relative hidden">
        <!-- Normal Log View -->
        <div id="log-container"
             class="relative rounded px-2 max-h-96 overflow-y-scroll text-sm transition-all duration-300 border border-cyan-500 bg-zinc-800/80 ">

            <!-- Fullscreen Button (top right) -->
            <button id="toggle-fullscreen-btn"
                    class="sticky top-2 left-full mr-3 bg-zinc-800 hover:bg-zinc-700 text-white px-2 py-1 rounded z-10 shadow flex items-center justify-center"
                    title="Toggle Fullscreen Log">
                <span class="material-icons" id="fullscreen-icon">fullscreen</span>
            </button>

            <pre id="log-output"
                 class="text-cyan-500  whitespace-pre-wrap break-words overflow-x-hidden max-w-full">Loading logs…</pre>

            <!-- Scroll-to-bottom Button (bottom right) -->
            <button id="scroll-bottom-btn"
                    title="Auto-scroll"
                    class="sticky bottom-2 left-full mr-3 ml-auto bg-zinc-800 hover:bg-zinc-700 text-white px-2 py-1 rounded z-10 shadow flex items-center justify-center cursor-pointer">
                <span class="material-icons">arrow_downward</span>
            </button>
        </div>
    </section>

    <!-- Env Panel -->
    <section id="env-panel" class="mt-2 relative hidden">
        <div class="relative rounded  text-sm transition-all duration-300  text-white">
            <textarea id="env-textarea" rows="25"
                      class="w-full h-64  bg-zinc-800/80 text-amber-500 p-3 rounded font-mono resize-y border border-yellow-600"
                      spellcheck="false">Loading .env…</textarea>

            <!-- Save button -->
            <div class="mt-2 flex justify-end gap-2">
                <div class=" bg-yellow-700/80 text-yellow-100 p-2 rounded border border-yellow-600 flex grow gap-2 items-center">
                    <span class="material-icons">warning</span>
                    Changes will be written to .env as-is. Invalid values could cause errors. Save only if you’re sure
                    of your changes.
                </div>

                <button id="save-env-btn"
                        class="bg-amber-500 hover:bg-amber-400 text-zinc-800 text-sm font-semibold  py-1 px-4 rounded shadow">
                    Save .env
                </button>
            </div>
        </div>
    </section>

    <div id="notification"
         class="hidden w-full fixed top-0 left-0 text-center backdrop-blur-xs text-white font-semibold py-2 px-4 rounded shadow-lg z-50 transition-opacity duration-300"></div>

</header>

<!-- Section 2–4 in responsive grid layout -->
<main id="main-content" class="max-w-6xl mx-auto">
    <div class="grid grid-cols-1 md:grid-cols-2 ">
        <!-- Settings Form -->
        <section>
            <form id="config-form" class="p-4 md:p-6">

                <!-- Software Settings -->
                <div class="bg-zinc-900/50 backdrop-blur-xs border border-zinc-700 p-4 md:p-6 rounded-lg shadow-sm mb-6 collapsible-section"
                     id="section-software">
                    <h3 class="flex items-center gap-2 cursor-pointer group text-lg grow justify-between font-bold mb-4 text-slate-200">
                        Software Settings
                        <span class="material-icons transition-transform duration-200 ml-2 rotate-0">expand_more</span>
                    </h3>

                    <div class="mb-4 relative">
                        <label for="OPENAI_API_KEY"
                               class="flex justify-between items-center font-semibold text-sm text-slate-300 relative">
                            OpenAI API Key
                            <span class="material-icons align-middle hover:text-cyan-400 cursor-pointer ml-1"
                                  onclick="toggleTooltip(this)">
                                help_outline
                            </span>
                        </label>
                        <div class="relative">
                            <div data-tooltip>
                                You need a <a href="https://platform.openai.com/account/api-keys"
                                              class="underline hover:text-cyan-400" target="_blank">secret API key</a>
                                with an available credit. In the <a
                                    href="https://platform.openai.com/account/billing/overview"
                                    class="underline hover:text-cyan-400" target="_blank">billing panel</a>, add a
                                payment method (under Payment Methods). After adding a payment method, add credits to
                                your organization by clicking 'Buy credits'.
                            </div>
                            <input
                                    type="password"
                                    class="w-full p-3 mt-1 pr-10 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                    id="OPENAI_API_KEY"
                                    name="OPENAI_API_KEY"
                                    value="{{ config.get('OPENAI_API_KEY', '') }}"
                                    placeholder="sk-proj..."
                            >
                            <button
                                    type="button"
                                    onclick="toggleInputVisibility('OPENAI_API_KEY', this)"
                                    class="absolute inset-y-0 right-0 flex items-center px-2 text-slate-400 hover:text-white cursor-pointer"
                            >
                                <span class="material-icons" id="OPENAI_API_KEY_icon">visibility</span>
                            </button>
                        </div>
                    </div>

                    <label class="block mb-4">
                        <label for="OPENAI_MODEL" class="flex justify-between items-center font-semibold text-sm text-slate-300 relative">
                            OpenAI Realtime API Model
                            <span class="material-icons align-middle hover:text-cyan-400 cursor-pointer ml-1"
                                  onclick="toggleTooltip(this)">
                                help_outline
                            </span>
                        </label>
                        <div class="relative">
                            <div data-tooltip>
                                Choose between the two realtime models that are currently available:<br>
                                <strong>gpt-4o-mini-realtime-preview</strong> is cheaper and the default.<br>
                                <strong>gpt-realtime</strong> is higher performance but also more expensive in token usage (~ ×6.66 compared to mini).
                                <br><br>
                                <strong>gpt-4o-realtime-preview</strong> is deprecated (and most expensive).<br><br>
                                See <a href="https://openai.com/api/pricing/" target="_blank" class="underline hover:text-cyan-400">OpenAI Realtime API Pricing</a> for details .
                            </div>

                            <select id="OPENAI_MODEL" name="OPENAI_MODEL"
                                    class="w-full p-3 mt-1 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500">
                                <option value="gpt-4o-mini-realtime-preview"
                                        {% if config.get(
                                'OPENAI_MODEL') == 'gpt-4o-mini-realtime-preview' %}selected{% endif %}>
                                gpt-4o-mini-realtime-preview (default)
                                </option>
                                <option value="gpt-realtime"
                                        {% if config.get(
                                'OPENAI_MODEL') == 'gpt-realtime' %}selected{% endif %}>
                                gpt-realtime (better but more expensive)
                                </option>
                                <option value="gpt-4o-realtime-preview" disabled
                                        {% if config.get(
                                'OPENAI_MODEL') == 'gpt-4o-realtime-preview' %}selected{% endif %}>
                                gpt-4o-realtime-preview (deprecated)
                                </option>
                            </select>
                        </div>
                    </label>

                    <div class="flex gap-2">
                        <div class="mb-4 grow flex flex-col justify-between">
                            <label for="hostname" class="block font-semibold text-sm text-slate-300">Device
                                Hostname</label>
                            <div class="flex items-center mt-1 gap-2">
                                <input
                                        id="hostname"
                                        name="hostname"
                                        type="text"
                                        data-original=""
                                        data-default="raspberrypi"
                                        class="w-full p-3  bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                        value=""
                                >
                                <span>.local:</span>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="FLASK_PORT" class="block font-semibold text-sm text-slate-300">Web UI
                                Port</label>
                            <input
                                    id="FLASK_PORT"
                                    name="FLASK_PORT"
                                    type="number"
                                    min="1"
                                    max="65535"
                                    data-default="80"
                                    class="w-full p-3 mt-1 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                    value="{{ config.get('FLASK_PORT', '80') }}"
                            >
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="RUN_MODE"
                               class="flex justify-between items-center font-semibold text-sm text-slate-300 relative">
                            Mode
                            <span class="material-icons align-middle hover:text-cyan-400 cursor-pointer ml-1"
                                  onclick="toggleTooltip(this)">help_outline</span>
                        </label>

                        <div class="relative">
                            <div data-tooltip>
                                After pressing the red button, Billy: </br>
                                <b>Normal:</b> tries to keep the conversation going until the mic silence timeout is
                                reached (see Audio Settings).<br>
                                <b>Dory:</b> responds only once, then ends and forgets the conversation.
                            </div>
                            <select id="RUN_MODE" name="RUN_MODE"
                                    class="w-full p-3 mt-1 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500">
                                <option value="normal" {% if config.get(
                                'RUN_MODE', 'normal') == 'normal' %}selected{% endif %}>Normal</option>
                                <option value="dory" {% if config.get(
                                'RUN_MODE') == 'dory' %}selected{% endif %}>Dory</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-4 relative">
                        <label for="VOICE" class="block font-semibold text-sm text-slate-300">Voice
                        </label>
                        <select id="VOICE" name="VOICE"
                                class="w-full p-3 mt-1 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500">
                            {% for v in config.get('VOICE_OPTIONS',[]) %}
                            <option value="{{ v }}" {% if config.get(
                            'VOICE') == v %}selected{% endif %}>
                            {{ v|capitalize }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Hardware Settings -->
                <div class="bg-zinc-900/50 backdrop-blur-xs border border-zinc-700 p-4 md:p-6 rounded-lg shadow-sm mb-6 collapsible-section"
                     id="section-hardware">
                    <h3 class="flex items-center gap-2 cursor-pointer group text-lg grow justify-between font-bold mb-4 text-slate-200">
                        Hardware Settings
                        <span class="material-icons transition-transform duration-200 ml-2 rotate-0">expand_more</span>
                    </h3>
                    <div class="mb-4">
                        <label for="BILLY_MODEL" class="block font-semibold text-sm text-slate-300">
                            Billy Version
                        </label>
                        <select id="BILLY_MODEL" name="BILLY_MODEL"
                                class="w-full p-3 mt-1 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500">
                            <option value="modern" {% if config.get(
                            'BILLY_MODEL', 'modern') == 'modern' %}selected{% endif %}>
                            Modern (2 motors)
                            </option>
                            <option value="classic" {% if config.get(
                            'BILLY_MODEL') == 'classic' %}selected{% endif %}>
                            Classic (3 motors)
                            </option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label for="RUN_MODE"
                               class="flex justify-between items-center font-semibold text-sm text-slate-300 relative">
                            Motor test
                            <span class="material-icons align-middle hover:text-cyan-400 cursor-pointer ml-1"
                                  onclick="toggleTooltip(this)">help_outline</span>
                        </label>

                        <div class="relative">
                            <div data-tooltip>
                                Use these buttons to test the motors individually.<br>
                                Each button will activate the corresponding motor for ~1 second.  Restart Billy when completed.
                        </div>
                            <div class="flex flex-wrap mt-1 gap-4">
                                <button type="button" id="test-mouth-btn"
                                        class="motor-test-btn bg-zinc-800 hover:bg-zinc-700 px-4 py-2 rounded">
                                    Mouth
                                </button>
                                <button type="button" id="test-head-btn"
                                        class="motor-test-btn bg-zinc-800 hover:bg-zinc-700 px-4 py-2 rounded">
                                    Head
                                </button>
                                <button type="button" id="test-tail-btn"
                                        class="motor-test-btn bg-zinc-800 hover:bg-zinc-700 px-4 py-2 rounded">
                                    Tail
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Audio -->
                <div class="bg-zinc-900/50 backdrop-blur-xs border border-zinc-700 p-4 md:p-6 rounded-lg shadow-sm mb-6 collapsible-section"
                     id="section-audio">
                    <h3 class="flex items-center gap-2 cursor-pointer group text-lg grow justify-between font-bold mb-4 text-slate-200">
                        Audio Settings
                        <span class="material-icons transition-transform duration-200 ml-2 rotate-0">expand_more</span>
                    </h3>

                    <div class="flex items-center gap-2 mb-4">
                        <span class="material-icons">settings_voice</span>
                        <span id="mic-label" class="grow">Loading...</span>
                    </div>

                    <div class="flex mb-4 gap-4">
                        <div class="flex-1/2 flex flex-col justify-between">
                            <label for="MIC_TIMEOUT_SECONDS" class="flex justify-between items-center font-semibold text-sm text-slate-300">
                                Mic Timeout (s)
                                <span class="material-icons align-middle hover:text-cyan-400 cursor-pointer ml-1"
                                      onclick="toggleTooltip(this)">
                                   help_outline
                                </span>
                            </label>
                            <div class="relative">
                                <div data-tooltip>
                                    How many seconds of silence Billy should wait after you stop talking before ending your turn.
                                    Lower = quicker response, higher = more forgiving.
                                </div>
                                <input type="number"
                                       class="w-full p-3 mt-1 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                       name="MIC_TIMEOUT_SECONDS" id="MIC_TIMEOUT_SECONDS"
                                       value="{{ config.get('MIC_TIMEOUT_SECONDS', '6') }}">
                            </div>
                        </div>

                        <div class="flex-1/2 flex flex-col justify-between">
                            <label for="SILENCE_THRESHOLD" class="block font-semibold text-sm text-slate-300">Silence
                                Threshold (RMS)
                            </label>
                            <input type="number" step="1" id="SILENCE_THRESHOLD"
                                   class="w-full p-3 mt-1 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                   name="SILENCE_THRESHOLD" value="{{ config.get('SILENCE_THRESHOLD', '1') }}">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="flex items-center justify-between font-semibold text-sm text-slate-300 mb-1">
                            Microphone level & Silence Threshold
                            <span class="material-icons align-middle hover:text-cyan-400 cursor-pointer ml-1"
                                  onclick="toggleTooltip(this)">
                                help_outline
                            </span>
                        </label>

                        <div class="flex gap-2 mb-4 relative">
                            <div data-tooltip>
                                Click “Test” to start a live microphone level preview.<br/>
                                You can drag the red line to adjust the <b>silence threshold</b>.<br/>
                                Billy will only consider audio as "speaking" when the bar crosses this threshold. <br/>
                                Adjust the <b>silence threshold</b> and/or <b>gain</b> so that in your normal environment,
                                the volume bar stays below the red line while idle (background noise) but
                                jumps above it when you speak. Restart Billy after completion.
                            </div>

                            <!-- Mic level bar container -->
                            <div id="mic-bar-container"
                                 class="relative mt-2 h-4 w-full rounded-full bg-zinc-700 overflow-hidden">
                                <!-- Fill bar -->
                                <div id="mic-level-bar"
                                     class="absolute left-0 top-0 h-full w-0 bg-emerald-500 transition-all duration-100"
                                ></div>

                                <!-- Threshold line -->
                                <div id="threshold-line"
                                     class="absolute top-0 bottom-0 w-[2px] bg-red-500 cursor-ew-resize"
                                     style="left: 10%;"
                                     draggable="false">
                                </div>
                            </div>

                            <button type="button" id="mic-check-btn"
                                    class="bg-zinc-800 hover:bg-zinc-700 text-white text-sm items-center px-2 py-1 rounded shadow w-20 flex gap-1.5 cursor-pointer">
                                <span class="material-icons align-middle">mic</span>
                                Test
                            </button>
                        </div>

                        <!-- Mic Gain Slider -->
                        <div class="mb-8 flex gap-2 items-center">
                            <div class="w-20 text-sm font-medium text-gray-200">
                                Gain: <span id="mic-gain-value">8</span>
                            </div>
                            <input type="range" id="mic-gain" min="0" max="16" step="1" value="8" class="hidden">
                            <div
                                    class="relative w-full rounded-full bg-zinc-700 overflow-hidden cursor-pointer h-4"
                                    id="mic-gain-bar"
                                    style="user-select: none;"
                            >
                                <div
                                        class="absolute left-0 top-0 h-full bg-emerald-500 transition-all duration-100"
                                        id="mic-gain-fill"
                                        style="width: 50%;"
                                        data-value="8"
                                ></div>
                            </div>
                        </div>
                    </div>


                    <div class="flex items-center gap-2 mb-4">
                        <span class="material-icons">speaker</span>
                        <span id="speaker-label" class="grow">Loading...</span>
                    </div>

                    <!-- Speaker Volume Slider -->
                    <div class="mb-4">
                        <label for="speaker-volume" class="block font-semibold text-sm text-slate-300 mb-1">
                            Speaker Volume
                        </label>
                        <div class="flex gap-2 items-center">
                            <input type="range" id="speaker-volume" min="0" max="100" value="50"
                                   class="hidden">
                            <div
                                    class="relative w-full rounded-full bg-zinc-700 overflow-hidden cursor-pointer h-4"
                                    id="speaker-volume-bar"
                                    style="user-select: none;"
                            >
                                <div
                                        class="absolute left-0 top-0 h-full bg-emerald-500 transition-all duration-100"
                                        id="speaker-volume-fill"
                                        style="width: 50%;"
                                        data-value="50"
                                ></div>
                            </div>
                            <button
                                    type="button"
                                    id="speaker-check-btn"
                                    class="bg-zinc-800 hover:bg-zinc-700 text-white text-sm items-center px-2 py-1 rounded shadow w-20 flex gap-1.5 cursor-pointer"
                            >
                                <span class="material-icons align-middle">volume_up</span>
                                Test
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Wake Word -->
                <div class="bg-zinc-900/50 backdrop-blur-xs border border-zinc-700 p-4 md:p-6 rounded-lg shadow-sm mb-6 collapsible-section"
                     id="section-wakeword">
                    <h3 class="flex items-center gap-2 cursor-pointer group text-lg grow justify-between font-bold mb-4 text-slate-200">
                        Wake Word
                        <span class="material-icons transition-transform duration-200 ml-2 rotate-0">expand_more</span>
                    </h3>

                    <div class="space-y-5">
                        <div class="flex items-start justify-between gap-4">
                            <div class="space-y-1">
                                <label for="WAKE_WORD_ENABLED" class="block font-semibold text-sm text-slate-300">
                                    Enable Wake Word
                                </label>
                                <p class="text-xs text-slate-400 max-w-prose">
                                    Keep the listener running while Billy is idle so you can say "Hey Billy" instead of
                                    pressing the physical button.
                                </p>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="WAKE_WORD_ENABLED" name="WAKE_WORD_ENABLED"
                                       class="w-5 h-5 text-cyan-500 bg-zinc-800 border border-zinc-600 rounded"
                                       {% if config.get('WAKE_WORD_ENABLED', 'false') == 'true' %}checked{% endif %}>
                                <span class="text-sm text-slate-300" id="wake-word-enabled-label">
                                    {% if config.get('WAKE_WORD_ENABLED', 'false') == 'true' %}On{% else %}Off{% endif %}
                                </span>
                            </div>
                        </div>

                        <div class="grid gap-4 md:grid-cols-2">
                            <div>
                                <label for="WAKE_WORD_ENGINE" class="block font-semibold text-sm text-slate-300">
                                    Detection Engine
                                </label>
                                <select id="WAKE_WORD_ENGINE" name="WAKE_WORD_ENGINE"
                                        class="w-full p-3 mt-1 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500">
                                    {% for engine in config.get('WAKE_WORD_ENGINE_OPTIONS', []) %}
                                    <option value="{{ engine }}" {% if config.get('WAKE_WORD_ENGINE') == engine %}selected{% endif %}>
                                        {{ engine|capitalize }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <p class="text-xs text-slate-400 mt-1">
                                    Choose the wake word backend. "openwakeword" loads an ONNX model on the device. Use "custom" to bridge a remote detector service.
                                </p>
                            </div>

                            <div>
                                <label for="WAKE_WORD_ENDPOINT" class="block font-semibold text-sm text-slate-300">
                                    Custom Endpoint
                                </label>
                                <input type="text" id="WAKE_WORD_ENDPOINT" name="WAKE_WORD_ENDPOINT"
                                       placeholder="http://localhost:9000/detect"
                                       value="{{ config.get('WAKE_WORD_ENDPOINT', '') }}"
                                       class="w-full p-3 mt-1 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500">
                                <p class="text-xs text-slate-400 mt-1">
                                    For OpenWakeWord, point this to the downloaded wake-word model file (e.g. <code>/home/pi/models/hey_billy.onnx</code>). Leave blank unless required.
                                </p>
                            </div>

                            <div class="md:col-span-2">
                                <label for="WAKE_WORD_PORCUPINE_ACCESS_KEY" class="block font-semibold text-sm text-slate-300">
                                    Porcupine Access Key
                                </label>
                                <input type="password" id="WAKE_WORD_PORCUPINE_ACCESS_KEY" name="WAKE_WORD_PORCUPINE_ACCESS_KEY"
                                       placeholder="pvx_..."
                                       value="{{ config.get('WAKE_WORD_PORCUPINE_ACCESS_KEY', '') }}"
                                       autocomplete="off"
                                       class="w-full p-3 mt-1 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500">
                                <p class="text-xs text-slate-400 mt-1">
                                    Required by Picovoice Porcupine. Grab it from the Picovoice Console and keep it private.
                                </p>
                            </div>
                        </div>

                        <div class="grid gap-4 md:grid-cols-2">
                            <div>
                                <label for="WAKE_WORD_SENSITIVITY" class="block font-semibold text-sm text-slate-300">
                                    Sensitivity (0.0 – 1.0)
                                </label>
                                <input type="number" step="0.05" min="0" max="1" id="WAKE_WORD_SENSITIVITY"
                                       name="WAKE_WORD_SENSITIVITY"
                                       value="{{ config.get('WAKE_WORD_SENSITIVITY', '0.5') }}"
                                       class="w-full p-3 mt-1 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500">
                                <p class="text-xs text-slate-400 mt-1">
                                    Increase to detect softer wake phrases, decrease if you get false triggers.
                                </p>
                            </div>

                            <div>
                                <label for="WAKE_WORD_THRESHOLD" class="block font-semibold text-sm text-slate-300">
                                    RMS Threshold
                                </label>
                                <input type="number" step="10" min="0" id="WAKE_WORD_THRESHOLD"
                                       name="WAKE_WORD_THRESHOLD"
                                       value="{{ config.get('WAKE_WORD_THRESHOLD', '2400') }}"
                                       class="w-full p-3 mt-1 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500">
                                <p class="text-xs text-slate-400 mt-1">
                                    Fallback detector activates when live audio RMS rises above this level.
                                </p>
                            </div>
                        </div>

                        <div class="border border-zinc-700 rounded-lg p-4 bg-zinc-900/40 space-y-3">
                            <div class="flex items-center justify-between gap-4">
                                <div>
                                    <h4 class="text-sm font-semibold text-slate-200">Listener Status</h4>
                                    <p class="text-xs text-slate-400" id="wake-word-status-detail">Loading…</p>
                                </div>
                                <span id="wake-word-state-badge"
                                      class="text-xs font-semibold px-2 py-1 rounded border border-zinc-700 bg-zinc-800 text-slate-300 uppercase tracking-wide">
                                    Loading
                                </span>
                            </div>
                            <div id="wake-word-last-error" class="text-xs text-rose-400 hidden"></div>

                            <div class="flex flex-wrap gap-2">
                                <button type="button" id="wake-word-test-trigger"
                                        class="flex items-center gap-1 px-3 py-1.5 rounded text-xs font-semibold bg-emerald-500/80 hover:bg-emerald-500 text-zinc-900">
                                    <span class="material-icons text-base">campaign</span>
                                    Simulate Detection
                                </button>
                                <button type="button" id="wake-word-test-stop"
                                        class="flex items-center gap-1 px-3 py-1.5 rounded text-xs font-semibold bg-amber-500/80 hover:bg-amber-500 text-zinc-900">
                                    <span class="material-icons text-base">stop</span>
                                    Stop Session
                                </button>
                                <button type="button" id="wake-word-events-refresh"
                                        class="flex items-center gap-1 px-3 py-1.5 rounded text-xs font-semibold bg-zinc-800 hover:bg-zinc-700 text-slate-200">
                                    <span class="material-icons text-base">refresh</span>
                                    Refresh
                                </button>
                            </div>

                            <div id="wake-word-events"
                                 class="max-h-48 overflow-y-auto text-xs bg-zinc-950/40 border border-zinc-800 rounded p-3 font-mono leading-relaxed">
                                Waiting for events…
                            </div>
                        </div>

                        <div class="border border-cyan-700/40 rounded-lg p-4 bg-zinc-900/30 space-y-4">
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                                <div>
                                    <h4 class="text-sm font-semibold text-slate-200">Calibration</h4>
                                    <p class="text-xs text-slate-400 max-w-prose">
                                        Measure ambient noise, then say your wake phrase so we can suggest reliable detection values.
                                    </p>
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    <button type="button" id="wake-word-cal-ambient"
                                            class="px-3 py-1.5 rounded text-xs font-semibold bg-cyan-500/80 hover:bg-cyan-500 text-zinc-900">
                                        <span class="material-icons text-base">waves</span>
                                        1. Measure Background
                                    </button>
                                    <button type="button" id="wake-word-cal-phrase"
                                            class="px-3 py-1.5 rounded text-xs font-semibold bg-cyan-500/30 text-slate-300 cursor-not-allowed"
                                            disabled>
                                        <span class="material-icons text-base">record_voice_over</span>
                                        2. Record Wake Phrase
                                    </button>
                                </div>
                            </div>

                            <div id="wake-word-cal-status" class="text-xs text-slate-400">
                                Ready for calibration.
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs text-slate-300">
                                <div class="bg-zinc-950/30 border border-zinc-800 rounded p-3">
                                    <h5 class="font-semibold text-slate-200 mb-1">Ambient</h5>
                                    <p>Noise RMS: <span id="wake-word-cal-ambient-rms">–</span></p>
                                    <p>Peak RMS: <span id="wake-word-cal-ambient-peak">–</span></p>
                                    <p>Suggested Threshold: <span id="wake-word-cal-ambient-threshold">–</span></p>
                                </div>
                                <div class="bg-zinc-950/30 border border-zinc-800 rounded p-3">
                                    <h5 class="font-semibold text-slate-200 mb-1">Wake Phrase</h5>
                                    <p>Peak RMS: <span id="wake-word-cal-phrase-peak">–</span></p>
                                    <p>OWW Score: <span id="wake-word-cal-phrase-score">–</span></p>
                                    <p>Suggested Sensitivity: <span id="wake-word-cal-sensitivity">–</span></p>
                                </div>
                            </div>

                            <div id="wake-word-cal-apply" class="hidden bg-emerald-900/20 border border-emerald-500/40 rounded p-3 text-xs text-slate-200">
                                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                                    <div>
                                        <p>Apply threshold <span class="font-semibold" id="wake-word-cal-apply-threshold">–</span>
                                            and sensitivity <span class="font-semibold" id="wake-word-cal-apply-sensitivity">–</span>
                                            to Billy.</p>
                                        <label class="inline-flex items-center gap-2 mt-1">
                                            <input type="checkbox" id="wake-word-cal-apply-persist" class="w-4 h-4 text-emerald-500 bg-zinc-800 border border-zinc-700" checked>
                                            <span>Also save to .env</span>
                                        </label>
                                    </div>
                                    <button type="button" id="wake-word-cal-apply-btn"
                                            class="self-start px-3 py-1.5 rounded text-xs font-semibold bg-emerald-500/80 hover:bg-emerald-500 text-zinc-900">
                                        <span class="material-icons text-base">done_all</span>
                                        Apply Suggestions
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MQTT Settings -->
                <div class="bg-zinc-900/50 backdrop-blur-xs border border-zinc-700 p-4 md:p-6 rounded-lg shadow-sm mb-6 collapsible-section"
                     id="section-mqtt">
                    <h3 class="flex items-center gap-2 cursor-pointer group text-lg grow justify-between font-bold mb-4 text-slate-200">
                        MQTT Settings
                        <span class="material-icons transition-transform duration-200 ml-2 rotate-0">expand_more</span>
                    </h3>

                    <div class="mb-4">
                        <label for="MQTT_HOST" class="block font-semibold text-sm text-slate-300">MQTT Host</label>
                        <input
                                id="MQTT_HOST"
                                name="MQTT_HOST"
                                type="text"
                                class="w-full p-3 mt-1 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                value="{{ config.get('MQTT_HOST', '') }}"
                        >
                    </div>

                    <div class="flex flex-wrap mb-4 gap-4">
                        <div class="w-full md:w-[calc(50%-0.5rem)]">
                            <label for="MQTT_USERNAME" class="block font-semibold text-sm text-slate-300">MQTT
                                Username</label>
                            <input
                                    id="MQTT_USERNAME"
                                    name="MQTT_USERNAME"
                                    type="text"
                                    class="w-full p-3 mt-1 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                    value="{{ config.get('MQTT_USERNAME', '') }}"
                            >
                        </div>
                        <div class="w-full md:w-[calc(50%-0.5rem)]">
                            <label for="MQTT_PASSWORD" class="block font-semibold text-sm text-slate-300">MQTT
                                Password</label>
                            <div class="relative">
                                <input
                                        id="MQTT_PASSWORD"
                                        name="MQTT_PASSWORD"
                                        type="password"
                                        class="w-full p-3 mt-1  bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                        value="{{ config.get('MQTT_PASSWORD', '') }}"
                                >
                                <button
                                        type="button"
                                        onclick="toggleInputVisibility('MQTT_PASSWORD', this)"
                                        class="absolute inset-y-0 right-0 flex items-center px-2 text-slate-400 hover:text-white cursor-pointer"
                                >
                                    <span class="material-icons" id="MQTT_PASSWORD_icon">visibility</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Home Assistant -->
                <div class="bg-zinc-900/50 backdrop-blur-xs border border-zinc-700 p-4 md:p-6 rounded-lg shadow-sm mb-6 collapsible-section"
                     id="section-ha">
                    <h3 class="flex items-center gap-2 cursor-pointer group text-lg grow justify-between font-bold mb-4 text-slate-200">
                        Home Assistant
                        <span class="material-icons transition-transform duration-200 ml-2 rotate-0">expand_more</span>
                    </h3>
                    <div class="mb-4">
                        <label for="HA_HOST" class="block font-semibold text-sm text-slate-300">Home Assistant
                            Host</label>
                        <input
                                id="HA_HOST"
                                name="HA_HOST"
                                type="text"
                                class="w-full p-3 mt-1 pr-10 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                value="{{ config.get('HA_HOST', '') }}"
                        >
                    </div>

                    <div class="mb-4">
                        <label for="HA_TOKEN" class="block font-semibold text-sm text-slate-300">Home Assistant
                            Token</label>
                        <div class="relative">
                            <input
                                    id="HA_TOKEN"
                                    name="HA_TOKEN"
                                    type="password"
                                    class="w-full p-3 mt-1 pr-10 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                    value="{{ config.get('HA_TOKEN', '') }}"
                            >
                            <button
                                    type="button"
                                    onclick="toggleInputVisibility('HA_TOKEN', this)"
                                    class="absolute inset-y-0 right-0 flex items-center px-2 text-slate-400 hover:text-white cursor-pointer"
                            >
                                <span class="material-icons" id="HA_TOKEN_icon">visibility</span>
                            </button>
                        </div>
                    </div>

                    <div>
                        <label for="HA_LANG" class="block font-semibold text-sm text-slate-300 mb-1">Language
                        </label>
                        {% set ha_languages = [
                        ('en', 'English'), ('sv', 'Swedish'), ('nl', 'Dutch'), ('it', 'Italian'), ('fr', 'French'),
                        ('de', 'German'), ('es', 'Spanish'), ('pt', 'Portuguese'), ('hi', 'Hindi'),
                        ('ja', 'Japanese'), ('zh', 'Chinese'), ('ko', 'Korean'), ('ru', 'Russian'),
                        ('pl', 'Polish'), ('cs', 'Czech'), ('tr', 'Turkish'), ('ro', 'Romanian'),
                        ('uk', 'Ukrainian'), ('vi', 'Vietnamese'), ('ar', 'Arabic'), ('id', 'Indonesian')
                        ] %}
                        <select name="HA_LANG" id="HA_LANG"
                                class="w-full p-3 mt-1 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500">
                            {% for code, label in ha_languages %}
                            <option value="{{ code }}" {% if config.get(
                            'HA_LANG') == code %}selected{% endif %}>
                            {{ label }} ({{ code }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </form>

            <div class="sticky bottom-0 z-10 p-4">
                <div class="flex justify-center">
                    <div class="relative inline-block">
                        <!-- Split button -->
                        <div class="flex rounded shadow overflow-hidden border border-emerald-500">
                            <button
                                    id="save-btn"
                                    class="bg-emerald-500 hover:bg-emerald-400 text-zinc-800 font-semibold py-2 px-4 flex items-center gap-1 focus:outline-none"
                                    type="submit"
                                    form="config-form"
                            >
                                <span class="material-icons align-middle">save</span>
                                Save Settings
                            </button>
                            <button
                                    id="dropdown-btn"
                                    type="button"
                                    class="dropdown-toggle bg-emerald-500 hover:bg-emerald-400 text-zinc-800 px-2 flex items-center"
                                    onclick="toggleDropdown(this)"
                            >
                                <span class="material-icons align-middle transition-transform duration-200">expand_more</span>
                            </button>
                        </div>
                        <!-- Dropdown -->
                        <div class="dropdown-menu absolute bottom-0 right-0 w-full text-zinc-800 border border-emerald-500  backdrop-blur-xs  rounded  z-20 hidden">
                            <button onclick="exportSettings()"
                                    class="w-full flex gap-2 items-center px-4 py-2 bg-emerald-500 hover:bg-emerald-400 cursor-pointer">
                                <span class="material-icons">file_download</span>
                                Export Settings
                            </button>
                            <label class="w-full flex gap-2 items-center px-4 py-2 bg-emerald-500/80relative bg-emerald-500 hover:bg-emerald-400 cursor-pointer">
                                <span class="material-icons">file_upload</span>
                                <span>Import Settings</span>
                                <input type="file" accept=".env" onchange="importSettings(this)" class="hidden"/>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Persona Column (consistent with Settings) -->
        <section class="space-y-4 md:space-y-6">
            <form id="persona-form" class="p-4 md:p-6">
                <!-- Persona Traits -->
                <div class="bg-zinc-900/50 backdrop-blur-xs border border-zinc-700 p-4 md:p-6 rounded-lg shadow-sm mb-6 collapsible-section"
                     id="section-persona-traits">
                    <h3 class="flex items-center gap-2 cursor-pointer group text-lg grow justify-between font-bold mb-4 text-slate-200">
                        Persona Traits
                        <span class="material-icons transition-transform duration-200 ml-2 rotate-0">expand_more</span>
                    </h3>
                    <div id="personality-sliders" class="space-y-4">
                        <!-- JS will populate this -->
                    </div>
                </div>

                <!-- Backstory -->

                <div class="bg-zinc-900/50 backdrop-blur-xs border border-zinc-700 p-4 md:p-6 rounded-lg shadow-sm mb-6 collapsible-section"
                     id="section-backstory-instructions">
                    <h3 class="flex items-center gap-2 cursor-pointer group text-lg grow justify-between font-bold mb-4 text-slate-200">
                        Backstory
                        <span class="material-icons transition-transform duration-200 ml-2 rotate-0">expand_more</span>
                    </h3>
                    <div>
                        <div id="backstory-fields" class="space-y-2"></div>
                        <button type="button" onclick="addBackstoryField()"
                                class="text-sm text-emerald-500 hover:text-emerald-400 mt-2 flex items-center cursor-pointer">
                            <span class="material-icons align-middle mr-1 ">add_circle_outline</span>
                            Add Field
                        </button>
                    </div>
                </div>

                <!-- Meta Instructions -->
                <div class="bg-zinc-900/50 backdrop-blur-xs border border-zinc-700 p-4 md:p-6 rounded-lg shadow-sm mb-6 collapsible-section"
                     id="section-instructions">
                    <h3 class="flex items-center gap-2 cursor-pointer group text-lg grow justify-between font-bold mb-4 text-slate-200">
                        Additional Instructions
                        <span class="material-icons transition-transform duration-200 ml-2 rotate-0">expand_more</span>
                    </h3>
                    <div>
                        <textarea name="META" id="meta-text" rows="16"
                                  class="w-full p-3 mt-1 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                  spellcheck="false"></textarea>
                    </div>
                </div>

                <!-- Wake-up Sounds -->
                <div class="bg-zinc-900/50 backdrop-blur-xs border border-zinc-700 p-4 md:p-6 rounded-lg shadow-sm mb-6 collapsible-section"
                     id="section-wakeup-sounds">
                    <h3 class="flex items-center gap-2 cursor-pointer group text-lg grow justify-between font-bold mb-4 text-slate-200">
                        Wake-up Sounds
                        <span class="material-icons transition-transform duration-200 ml-2 rotate-0">expand_more</span>
                    </h3>

                    <div id="wakeup-sound-list" class="space-y-2">

                    </div>

                    <button type="button" onclick="addWakeupSound()"
                            class="text-sm text-emerald-500 hover:text-emerald-400 mt-2 flex items-center cursor-pointer">
                        <span class="material-icons align-middle mr-1">add_circle_outline</span>
                        Add Wake-up Sound
                    </button>
                </div>

            </form>

            <div class="sticky bottom-0 z-10 p-4">
                <div class="flex justify-center">
                    <div class="relative inline-block">
                        <!-- Split button -->
                        <div class="flex rounded shadow overflow-hidden border border-emerald-500">
                            <button
                                    id="save-persona-btn"
                                    class="bg-emerald-500 hover:bg-emerald-400 text-zinc-800 font-semibold py-2 px-4 flex items-center gap-1 focus:outline-none"
                                    type="submit"
                                    form="persona-form"
                            >
                                <span class="material-icons align-middle">person</span>
                                Save Persona
                            </button>
                            <button
                                    id="persona-dropdown-btn"
                                    type="button"
                                    class="dropdown-toggle bg-emerald-500 hover:bg-emerald-400 text-zinc-800 px-2 flex items-center"
                                    onclick="toggleDropdown(this)"
                            >
                                <span class="material-icons align-middle transition-transform duration-200">expand_more</span>
                            </button>
                        </div>
                        <!-- Dropdown -->
                        <div
                                class="dropdown-menu absolute bottom-0  right-0 w-full text-zinc-800 border border-emerald-500 rounded z-20 hidden"
                        >
                            <button onclick="exportPersona()"
                                    class="w-full flex gap-2 items-center px-4 py-2 bg-emerald-500 hover:bg-emerald-400 cursor-pointer">
                                <span class="material-icons">file_download</span>
                                Export Persona
                            </button>
                            <label class="w-full flex gap-2 items-center px-4 py-2 bg-emerald-500 hover:bg-emerald-400 cursor-pointer">
                                <span class="material-icons">file_upload</span>
                                <span>Import Persona</span>
                                <input type="file" accept=".ini" onchange="importPersona(this)" class="hidden"/>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</main>

<footer class="backdrop-blur-xs fixed bottom-0 p-4 left-0 w-full h-20 shadow-[0_-6px_12px_rgba(0,0,0,0.2)]">

</footer>
<script src="{{ url_for('static', filename='js/config.js') }}"></script>
</body>
</html>
